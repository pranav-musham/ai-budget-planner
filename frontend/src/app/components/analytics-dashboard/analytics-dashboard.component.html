<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Dashboard</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="navigateToAddExpense()">
        <mat-icon>add_circle</mat-icon>
        Enter Expense
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading analytics...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading" class="dashboard-content">

    <!-- Summary Cards -->
    <div class="summary-cards">
      <mat-card class="summary-card total-income">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>attach_money</mat-icon>
          </div>
          <div class="card-info">
            <h3>Total Income</h3>
            <p class="amount">${{ totalIncome.toFixed(2) }}</p>
            <span class="subtitle">All time</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card total-spending">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <div class="card-info">
            <h3>Total Expense</h3>
            <p class="amount">${{ totalSpending.toFixed(2) }}</p>
            <span class="subtitle">All time</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card avg-spending">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>calendar_month</mat-icon>
          </div>
          <div class="card-info">
            <h3>Avg Monthly Expenses</h3>
            <p class="amount">${{ averageMonthlyExpenses.toFixed(2) }}</p>
            <span class="subtitle">Per month</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card total-savings" [class.negative-savings]="totalSavings < 0">
        <mat-card-content>
          <div class="card-icon">
            <mat-icon>savings</mat-icon>
          </div>
          <div class="card-info">
            <h3>Total Savings</h3>
            <p class="amount" [class.negative]="totalSavings < 0">
              {{ totalSavings >= 0 ? '' : '-' }}${{ (totalSavings >= 0 ? totalSavings : -totalSavings).toFixed(2) }}
            </p>
            <span class="subtitle">Income - Expenses</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">

      <!-- Weekly Spending Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>show_chart</mat-icon>
            Weekly Spending Trend
          </mat-card-title>
          <mat-card-subtitle>Last 8 weeks</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div #weeklyChart class="chart-container" *ngIf="weeklyData.length > 0"></div>
          <div *ngIf="weeklyData.length === 0" class="empty-chart">
            <mat-icon>inbox</mat-icon>
            <p>No weekly data available yet</p>
            <button mat-raised-button color="primary" (click)="navigateToAddExpense()">
              Add Your First Expense
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Monthly Spending Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bar_chart</mat-icon>
            Monthly Spending
          </mat-card-title>
          <mat-card-subtitle>Last 6 months</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div #monthlyChart class="chart-container" *ngIf="monthlyData.length > 0"></div>
          <div *ngIf="monthlyData.length === 0" class="empty-chart">
            <mat-icon>inbox</mat-icon>
            <p>No monthly data available yet</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Category Pie Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>pie_chart</mat-icon>
            Spending by Category
          </mat-card-title>
          <mat-card-subtitle>Current month distribution</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div #categoryPieChart class="chart-container pie-chart" *ngIf="categoryData.length > 0"></div>
          <div *ngIf="categoryData.length === 0" class="empty-chart">
            <mat-icon>inbox</mat-icon>
            <p>No category data available yet</p>
          </div>

          <!-- Category Legend -->
          <div class="category-legend" *ngIf="categoryData.length > 0">
            <div class="legend-item" *ngFor="let cat of categoryData">
              <div class="legend-color" [style.background-color]="getCategoryColor(cat.category)"></div>
              <span class="legend-label">{{ cat.category }}</span>
              <span class="legend-value">${{ cat.amount.toFixed(2) }} ({{ cat.percentage.toFixed(1) }}%)</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Monthly Income Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>account_balance</mat-icon>
            Monthly Income
          </mat-card-title>
          <mat-card-subtitle>Last 6 months</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div #incomeChart class="chart-container" *ngIf="monthlyIncomeData.length > 0"></div>
          <div *ngIf="monthlyIncomeData.length === 0" class="empty-chart">
            <mat-icon>inbox</mat-icon>
            <p>No income data available yet</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Savings Per Month Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>trending_up</mat-icon>
            Savings Per Month
          </mat-card-title>
          <mat-card-subtitle>Income minus expenses</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div #savingsChart class="chart-container" *ngIf="monthlySavingsData.length > 0"></div>
          <div *ngIf="monthlySavingsData.length === 0" class="empty-chart">
            <mat-icon>inbox</mat-icon>
            <p>No savings data available yet</p>
          </div>

          <!-- Savings Legend -->
          <div class="savings-legend" *ngIf="monthlySavingsData.length > 0">
            <div class="legend-item">
              <div class="legend-color" style="background-color: #2563eb;"></div>
              <span class="legend-label">Surplus (positive savings)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #ef4444;"></div>
              <span class="legend-label">Deficit (expenses exceed income)</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Category-Merchant Statistics -->
    <div class="category-merchant-section" *ngIf="categoryMerchantStats.length > 0">
      <h2>
        <mat-icon>store</mat-icon>
        Category-wise Merchant Statistics
      </h2>
      <mat-accordion multi>
        <mat-expansion-panel *ngFor="let catGroup of categoryMerchantStats">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <div class="merchant-panel-title">
                <span class="cat-label">{{ catGroup.category }}</span>
                <span class="cat-total">${{ catGroup.totalAmount.toFixed(2) }}</span>
              </div>
            </mat-panel-title>
            <mat-panel-description>
              {{ catGroup.merchants.length }} merchant{{ catGroup.merchants.length !== 1 ? 's' : '' }}
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="merchant-list">
            <div class="merchant-row" *ngFor="let m of catGroup.merchants">
              <div class="merchant-info">
                <mat-icon class="merchant-icon">storefront</mat-icon>
                <span class="merchant-name">{{ m.merchantName }}</span>
              </div>
              <div class="merchant-stats">
                <span class="merchant-count">{{ m.transactionCount }} txn{{ m.transactionCount !== 1 ? 's' : '' }}</span>
                <span class="merchant-amount">${{ m.totalAmount.toFixed(2) }}</span>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>


  </div>
</div>
